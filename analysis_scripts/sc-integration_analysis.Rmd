---
title: "Untitled"
output: html_document
date: "2023-03-22"
---

#Libraries.
```{r, message=F}
library(ggplot2)
library(dplyr)
library(reshape2)
library(ggpubr)

```


#We need new figures, Plot markers in dot plots for the whole dataset coming from Merge2 object.
```{r}
marker_list <- c("Myh11", "Acta2", "Mylk","Myl9", "Smtn", "Tagln", "Mcam", "Pdgfrb", "Rgs5", "Cd248", "Anpep", "Des", "Pdgfra", "Tcf21", "Postn", "Fap", "Vim", "Fbln1", "Fbln2", "Col1a1", "Col3a1", "Ly6a", "Nes", "Col4a1", "Chl1", "Cadm1", "Kcnq5", "Mfap5", "Dio2", "Dpep1", "Podn", "Kcna1", "Foxd3" )

samples <- as.character(unique(Merge2_Object@coldata$Set))
Clusters <- c(4, 1, 6, 5, 12, 2, 3, 7, 8, 9, 10, 11)
#metadata_integration <- Merge2_Object@coldata
```


```{r}
markers_dot_plot <- function(marker_list, samples, cluster_to_plot, figure_name){
  markers_df <- data.frame(matrix(nrow = length(marker_list)))
  for ( i in samples){
    tryCatch({
      one_sample_df <- as.data.frame(Merge2_Object@assay$logcount[[i]][marker_list,])
      markers_df <- cbind(markers_df,one_sample_df)
    }, error=function(e){})
  }
  
  markers_df[,1] <- NULL
  
  all_markers_clusters <- data.frame()
  for (j in cluster_to_plot){
    tryCatch({
      cluster_meta_data<-metadata_integration %>% dplyr::filter(Set %in% samples) %>% filter(Cluster==j)
      cells_cluster_meta_data <- cluster_meta_data$Barcode
      
      cluster_mat2 <- markers_df[, cells_cluster_meta_data]
      
      cluster_genes <- as.data.frame(rownames(cluster_mat2))
      
      calculate_percentage <- function(x){as.numeric(table(cluster_mat2[x,]==0)["FALSE"])*100/length(cluster_mat2[x,]==0)}
      
      cluster_genes$percentage <- as.numeric(lapply(rownames(cluster_mat2), calculate_percentage))
      
      
      cluster_genes$expression <- as.numeric(rowMeans(cluster_mat2))
      cluster_genes$Cluster <- rep(paste0(j), nrow(cluster_genes))
      cluster_genes <- cluster_genes %>% dplyr::rename(genes=`rownames(cluster_mat2)`)
      
      
      all_markers_clusters <- rbind(all_markers_clusters,cluster_genes)
    }, error=function(e){})
  }
  
  all_markers_clusters$Cluster <- factor(all_markers_clusters$Cluster, levels = cluster_to_plot)
  write.table(all_markers_clusters, paste0(figure_name))
  
  #png(file="/Users/mastorkia/Dropbox (EinsteinMed)/Infart_Nikolaos_scRNAseq/Revision2/markers_plots/all_cluster_together.png", width=600, height=350)
  #tiff(file =paste0("Revision2/markers_plot/",figure_name, "_markers.tiff"),  
       #width = 500,
       #height = 700)
  
  #dot_plot <- ggplot(data = all_markers_clusters, aes(x = Cluster, y = genes)) +
    #geom_point(aes(size =  percentage, colour = expression))+
    #scale_color_gradient2(limits=c(0, 10)) +
    #theme_linedraw() +
    #scale_x_discrete(position = "bottom") +
    #theme(plot.title = element_text(hjust = 0.5)) +
    #theme(text = element_text(size = 14),plot.title = element_text(size=14, face="plain"),
          #axis.text.x = element_text(angle = 90, hjust=1),
          #axis.text.y = element_text(angle = 0, hjust=1),
          #axis.title.x = element_blank(),
          #axis.title.y = element_blank()) +
    #theme(axis.line.x = element_line(size = 0.25), axis.line.y = element_line(size = 0.25)) +
    #theme(panel.grid.major = element_line(colour="grey90", size = (0.1))) 
  #print(dot_plot)
  #dev.off()
  
  #Lets create a matrix to then create distances for dendogram
  #for_dend <- acast(all_markers_clusters, Cluster~genes, value.var="expression")
  #d <- dist(for_dend)
  
  # Hierarchical clustering
  #hc <- hclust(d)
  
  #tiff(file =paste0("Revision2/markers_plot/",figure_name, "_dendogram.tiff"),  
   #    width = 500,
    #   height = 700)
  
  
  # Dendrogram
  #dendogram_plot <- plot(hc)
  #print(dendogram_plot)
  #dev.off()
  #return(dot_plot)
}
```

```{r}
markers_dot_plot(marker_list, samples, Clusters, "FigureA_NEW")
```

#b.After this, I assume we will show separate plots for control and infarct. We could make a plot with the same genes for the clusters present in control hearts (4, 1, 6, 5, 12 control vs infarct),followed by the clusters found (almost exclusively) in infarcts (2, 3, 7, 8, 9, 10, 11). However, this may not be optimal. I think it will be better to make 2 different plots that illustrate the changes instead.
```{r}
samples <-c("Heart1n2","Heart3n4","Heart5" )
Clusters <- c(2, 3, 7, 8, 9, 10, 11)
markers_dot_plot(marker_list, samples, Clusters, "Sup_figure_A2")

```

```{r}
samples <-c("Control3n4","Control1n2")
Clusters <- c(4, 1, 6, 5, 12)
markers_dot_plot(marker_list, samples, Clusters, "Sup_figure_A1")
```


#One plot (Figure C) would focus on genes supporting the activated nature of the new clusters that emerge after MI. This plot would have all the clusters (in the same order as above, first the resident then the new infarct clusters) and the following genes:
#Timp1, Mmp2, Mmp14,Pdgfa, Cxcl12, Hgf, Tgfb3, Fmod,Bgn, Thbs4, Cdk1, Cdk2,Ccna1, Il6, Il33,Cxcl16, Vegfd, Sfrp1, Sfrp2,Ptgs1,Ptgs2, Ptges, Zfpm2,Gpc6. 
```{r}
marker_list <- c("Timp1", "Mmp2", "Mmp14","Pdgfa", "Cxcl12", "Hgf", "Tgfb3", "Fmod","Bgn", "Thbs4", "Cdk1", "Cdk2", "Il6", "Il33","Cxcl16", "Vegfd", "Sfrp1", "Sfrp2","Ptgs1","Ptgs2", "Ptges", "Zfpm2","Gpc6", "Aspn", "Ogn", "Thbs4", "Hist1h1a")

samples <- as.character(unique(Merge2_Object@coldata$Set))
Clusters <- c(4, 1, 6, 5, 12, 2, 3, 7, 8, 9, 10, 11)

markers_dot_plot(marker_list, samples, Clusters, "Sup_figure_A3")
```

#The other new plot (Figure D) would show the comparison between control and infarct cells for the clusters represented in control hearts. This plot would show the following genes only for clusters 4, 1, 6, 5 and 12 in control vs infarcts: Col1a1, Col3a1,Pcolce,Timp1, loxl2, Fap,Postn, Acta2, Myh11,Mylk, Thbs1, Tnc,Lox.
```{r}
marker_list <- c("Col1a1", "Col3a1","Pcolce","Timp1", "Loxl2", "Fap","Postn", "Acta2", "Myh11","Mylk", "Thbs1", "Tnc","Lox", "Il6", "Il33", "Il34", "Il15", "Cxcl16", "Vegfd", "Sfrp1", "Sfrp2")

samples_control <- c("Control3n4","Control1n2")
samples_heart <- c("Heart1n2","Heart3n4","Heart5" )
Clusters <- c(4, 1, 6, 5, 12)
samples_all <- as.character(unique(Merge2_Object@coldata$Set))

Sup_figure_A4_1 <- markers_dot_plot(marker_list, samples_control, Clusters, "Sup_figure_A4_1")
Sup_figure_A4_2 <- markers_dot_plot(marker_list, samples_heart, Clusters, "Sup_figure_A4_2")
tiff(file ="Revision2/markers_plot/combined_Sup_figure_A4.tiff",  
      width = 800,
      height = 700)
test <- ggarrange(Sup_figure_A4_1,Sup_figure_A4_2, 
           labels = c("Control", "Infarct"),
           ncol = 2, nrow = 1)
print(test)
dev.off()
```

#Now subset randonmly 3000 cells for MI hearts and rerun integration.
```{r}
#Subset by randomly subseted cells.
#heart3n4_cells <- Merge2_Object@coldata %>% filter(grepl("Heart3n4", Set)) %>% rownames()
randome_heart3n4_cells <- sample(heart3n4_cells, 2000, replace = F)
heart3n4_cells <- Merge2_Object@coldata %>% filter(scBarcode %in% randome_heart3n4_cells) %>% rownames()

#heart5_cells <- Merge2_Object@coldata %>% filter(grepl("Heart5", Set)) %>% rownames()
randome_heart5_cells <- sample(heart5_cells, 1000, replace = F)
heart5_cells <- Merge2_Object@coldata %>% filter(scBarcode %in% randome_heart5_cells) %>% rownames()

```


```{r}
randome_heart3n4_cells <- stringr::str_remove(randome_heart3n4_cells, "Heart3n4_")
randome_heart5_cells <- stringr::str_remove(randome_heart5_cells, "Heart5_")
```


```{r}

Object_RISC2_random_subset<- Object_RISC2 

Object_RISC2_random_subset$Heart3n4 <- SubSet(Object_RISC2_random_subset$Heart3n4, cells = randome_heart3n4_cells)

Object_RISC2_random_subset$Heart5 <- SubSet(Object_RISC2_random_subset$Heart5, cells = randome_heart5_cells)
```


#Lets start with the integration.
```{r}
var0 = Reduce(
  intersect, list(
    Object_RISC2_random_subset$Control1n2@rowdata$Symbol, Object_RISC2_random_subset$Control3n4@rowdata$Symbol, Object_RISC2_random_subset$Heart1n2@rowdata$Symbol, Object_RISC2_random_subset$Heart3n4@rowdata$Symbol,
    Object_RISC2_random_subset$Heart5@rowdata$Symbol 
  )
)

InPlot(Object_RISC2_random_subset, var.gene = var0, Std.cut = 0.99, ncore = 4, minPC = 16, nPC = 20)
```


```{r}
set.seed(123)
#List to integrate the data. In this case we use Heart1n2 as reference.
Merge_list_random = list(Object_RISC2_random_subset$Heart1n2,Object_RISC2_random_subset$Heart3n4, Object_RISC2_random_subset$Control3n4, Object_RISC2_random_subset$Heart5, Object_RISC2_random_subset$Control1n2)
```

#Integrate again.
```{r}
Integration_Ids <- c("Heart1n2","Heart3n4", "Control3n4", "Heart5", "Control1n2")
Merge4_Object = scMultiIntegrate(
  objects = Merge_list_random, eigens = 20, add.Id = Integration_Ids, var.gene = var0,
  align = 'OLS', npc = 50, adjust = TRUE, ncore = 4
)
```

#Create a condition colunm.
```{r}
Merge4_Object@coldata <- Merge4_Object@coldata %>% rename(Condition=Set)
Merge4_Object@coldata <- Merge4_Object@coldata %>% rename(Set=orig.ident)
Merge4_Object@coldata$Condition <- as.character(Merge4_Object@coldata$Condition)
Merge4_Object@coldata$Condition[Merge4_Object@coldata$Condition=="Heart1n2"] <- "Infart"
Merge4_Object@coldata$Condition[Merge4_Object@coldata$Condition=="Heart3n4"] <- "Infart"
Merge4_Object@coldata$Condition[Merge4_Object@coldata$Condition=="Heart5"] <- "Infart"
Merge4_Object@coldata$Condition[Merge4_Object@coldata$Condition=="Control1n2"] <- "Control"
Merge4_Object@coldata$Condition[Merge4_Object@coldata$Condition=="Control3n4"] <- "Control"

saveRDS(Merge4_Object, file = paste0("Revision2/Merged4_RISC.rds"))
```

#Lets run UMAP reduction.
```{r}
Merge4_Object = scUMAP(Merge4_Object, npc = 20, use = "PLS")

Merge4_Object = scCluster(Merge4_Object, slot = "cell.pls", neighbor = 14, method = "louvain", npc = 20)
print(table(Merge4_Object@coldata$Cluster))

RISC::DimPlot(Merge4_Object, slot = "cell.umap", colFactor = "Cluster", Colors = c("#00008b", "gray", "#00BA38", "#00BFC4", "#C77CFF", "brown", "#7CAE00", "#F8766D", "#F564E3", "#fadadd", "#B79F00", "#DE8C00","#de2c00" ))
```

#Subset each sample and plot integration.
```{r}
plot_each_samples <- function(sample){
  sample_cells <- Merge4_Object@coldata %>% filter(Set==sample) %>% rownames()
  subset_object <- SubSet(Merge4_Object, cells = sample_cells)
  png(file =paste0("Revision2/heart1_ref_subset_heart5_heart2_plots_results/",sample, "_Integration_subset_2.png"),  
      width = 800,
      height = 800)
  plot <- RISC::DimPlot(subset_object, slot = "cell.umap", colFactor = "Cluster", Colors = c("#00008b", "gray", "#00BA38", "#00BFC4", "#C77CFF", "brown", "#7CAE00", "#F8766D", "#F564E3", "#fadadd", "#B79F00", "#DE8C00", "#de2c00"))
  print(plot)
  dev.off()
}
```

```{r}
plot_each_samples("Heart1n2")
plot_each_samples("Heart3n4")
plot_each_samples("Heart5")
plot_each_samples("Control3n4")
plot_each_samples("Control1n2")
```


```{r}
plot_condition <- function(condition){
  sample_cells <- Merge4_Object@coldata %>% filter(Condition==condition) %>% rownames()
  subset_object <- SubSet(Merge4_Object, cells = sample_cells)
  png(file =paste0("Revision2/heart1_ref_subset_heart5_heart2_plots_results/",condition, "_Integration_subset_2.png"),  
      width = 800,
      height = 800)
  plot <- RISC::DimPlot(subset_object, slot = "cell.umap", colFactor = "Cluster", Colors = c("#00008b", "gray", "#00BA38", "#00BFC4", "#C77CFF", "brown", "#7CAE00", "#F8766D", "#F564E3", "#fadadd", "#B79F00", "#DE8C00", "#de2c00"))
  print(plot)
  dev.off()
}

plot_condition("Infart")
plot_condition("Control")
```

#Let create a table with number of cells per cluster and condition.
```{r}
Merge4_metadata <- Merge4_Object@coldata
clusters <- unique(Merge4_metadata$Cluster)
Set_cluster_number <- data.frame(Var1=clusters)
for ( i in unique(Merge4_metadata$Set)){
  Merge4_metadata_set <- Merge4_metadata %>% filter(Set==i)
  cluster_table <- as.data.frame(table(Merge4_metadata_set$Cluster))
  cluster_table <- cluster_table %>% dplyr::rename(!!paste0(i) := Freq)
  Set_cluster_number <- join(Set_cluster_number,cluster_table, type="inner")
}
Set_cluster_number <- Set_cluster_number %>% dplyr::rename(Cluster = Var1)
write.csv(Set_cluster_number, "Revision2/heart1_ref_subset_heart5_heart2_plots_results/Sample_cluster_number_integrate_subset_2.csv", row.names = F)

```

#Run marker identification.
```{r}
Merge4_integration_markers <- AllMarker(
    Merge4_Object,
    positive = FALSE,
    frac = 0.25,
    log2FC = 0.25,
    Padj = 0.01,
    latent.factor = NULL,
    min.cells = 25L,
    method = "Wilcox",
    ncore = 1
)
write.csv(Merge4_integration_markers, "Revision2/heart1_ref_subset_heart5_heart2_plots_results/Integration_random_subset_markers_2.csv", row.names = F)

```


#Compare markers from Integration2 and this new integration.
```{r}
marker_comparison_df <- function(Integrated_markers,Individual.markers){
Batch_comparison<-data.frame()
  for ( i in unique(Integrated_markers$Cluster)){
    Integrated_markers_cluster <- Integrated_markers %>% filter(Cluster==i) %>% dplyr::select(Symbol, Cluster)
    Integrated_markers_genes <- Integrated_markers_cluster$Symbol
    one_cluster_values <- data.frame()
    for (j in unique(Individual.markers$Cluster)){
      Control1n2.markers_cluster <- Individual.markers %>% dplyr::filter(Cluster==j) %>% dplyr::select(Symbol, Cluster)
      Control1n2.markers_genes <- Control1n2.markers_cluster$Symbol
      Intersect <-length(intersect(Integrated_markers_genes,Control1n2.markers_genes))
      All_data <- i
      Subset_data <- j
      pasted<-cbind(All_data, Subset_data, Intersect)
      one_cluster_values <- rbind(one_cluster_values, pasted)
    }
    Batch_comparison <- rbind(Batch_comparison, one_cluster_values)
  
  }
#Batch_comparison$inserct <-as.numeric(Batch_comparison$inserct)
Batch_comparison <- Batch_comparison %>% arrange(desc(Intersect))
return(Batch_comparison)
}
```

#Subset.
```{r}
Integrated2_markers %>%
  group_by(Cluster) %>%
  top_n(n = 10, wt = log2FC) -> Integrated2_markers_top10
Merge4_integration_markers %>%
  group_by(Cluster) %>%
  top_n(n = 10, wt = log2FC) -> Merge4_integration_markers_top10

```


#Run function
```{r}
Compare_total_subset_new_integr <- marker_comparison_df(Integrated2_markers_top10,Merge4_integration_markers_top10)
Compare_total_subset_new_integr$Intersect <- as.numeric(Compare_total_subset_new_integr$Intersect)
Compare_total_subset_new_integr <- Compare_total_subset_new_integr %>% filter(Intersect > 1)
```


#Plot alluvial.
```{r}
alluvial_top10 <- ggplot(data = Compare_total_subset_new_integr,
       aes(axis1 = All_data, axis2 = Subset_data, y = Intersect)) +
  geom_alluvium(aes(fill = All_data)) +
  geom_stratum(aes(fill = All_data)) +
  geom_stratum() +
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum))) +
  theme_void()
```

#Instead of top marker trace subseted cells.
```{r}
coldata_merge2_subset <- Merge2_Object@coldata
coldata_Merge4_subset <- Merge4_Object@coldata
```

#Just with the subseted data 
```{r}
random_cell <- c(heart3n4_cells,heart5_cells)
coldata_merge2_subset <- Merge2_Object@coldata[random_cell,]
coldata_merge4_subset <- Merge4_Object@coldata[random_cell,]

```


```{r}
#Compare cell barcodes from Integration2 and this new integration.
marker_comparison_df <- function(coldata_merge2_subset,coldata_Merge4_subset){
  Batch_comparison<-data.frame()
  for ( i in unique(coldata_merge2_subset$Cluster)){
    Integrated_cells_cluster <- coldata_merge2_subset %>% filter(Cluster==i) %>% dplyr::select(Barcode, Cluster)
    Integrated_cells <- Integrated_cells_cluster$Barcode
    one_cluster_values <- data.frame()
    for (j in unique(coldata_Merge4_subset$Cluster)){
      subset.cells_cluster <- coldata_Merge4_subset %>% dplyr::filter(Cluster==j) %>% dplyr::select(Barcode, Cluster)
      subset.cells <- subset.cells_cluster$Barcode
      Intersect <-length(intersect(Integrated_cells,subset.cells))
      All_data <- i
      Subset_data <- j
      pasted<-cbind(All_data, Subset_data, Intersect)
      one_cluster_values <- rbind(one_cluster_values, pasted)
    }
    Batch_comparison <- rbind(Batch_comparison, one_cluster_values)
    
  }
  #Batch_comparison$inserct <-as.numeric(Batch_comparison$inserct)
  Batch_comparison <- Batch_comparison %>% arrange(desc(Intersect))
  return(Batch_comparison)
}

cell_intersect <- marker_comparison_df(coldata_merge2_subset,coldata_Merge4_subset)
cell_intersect$Intersect <- as.numeric(cell_intersect$Intersect)
#cell_intersect <- cell_intersect %>% filter(Intersect > 50)

```

#Plot alluvial
```{r}
ggplot(data = cell_intersect,
       aes(axis1 = All_data, axis2 = Subset_data, y = Intersect)) +
     geom_alluvium(aes(fill = All_data)) +
     geom_stratum(aes(fill = All_data)) +
     geom_stratum() +
     geom_text(stat = "stratum",
               aes(label = after_stat(stratum))) +
     theme_void()
```

